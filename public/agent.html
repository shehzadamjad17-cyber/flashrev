<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Agent Console</title>

  <style>
    body { font-family: Arial, sans-serif; background:#f5f5f5; padding:20px; }
    .box {
      background:#111; color:#0f0; padding:10px;
      height:220px; overflow-y:auto;
      font-family:monospace; font-size:13px;
    }
    input { padding:6px; margin:4px 0; }
    button { padding:6px 14px; margin-top:6px; }
    label { margin-right:12px; }
    .hidden { display:none; }
  </style>
</head>
<body>

<h2>üé§ Agent Console (Dual Source)</h2>

<!-- üîê LOGIN -->
<div id="login">
  <h3>Agent Login</h3>
  <input id="username" placeholder="Username"><br>
  <input id="password" type="password" placeholder="Password"><br>
  <button id="loginBtn">Login</button>
</div>

<!-- üéôÔ∏è APP -->
<div id="app" class="hidden">
  <p><strong>Logged in as:</strong> <span id="agentName"></span></p>

  <label><input type="checkbox" id="useMic" checked> üé§ Mic</label>
  <label><input type="checkbox" id="useTab"> üñ•Ô∏è Tab Audio</label>

  <br><br>

  <button id="start">Start Call</button>
  <button id="stop" disabled>Stop Call</button>

  <h4>Log</h4>
  <div class="box" id="log"></div>
</div>

<script>
/* ================= STATE ================= */
let ws;
let ctx;
let running = false;

let micStream, tabStream;
let micProcessor, tabProcessor;

const logEl = document.getElementById("log");
const loginDiv = document.getElementById("login");
const appDiv = document.getElementById("app");
const startBtn = document.getElementById("start");
const stopBtn = document.getElementById("stop");

/* ================= LOG ================= */
function log(msg) {
  logEl.innerHTML += msg + "<br>";
  logEl.scrollTop = logEl.scrollHeight;
}

/* ================= PCM ================= */
function floatTo16BitPCM(float32) {
  const buffer = new ArrayBuffer(float32.length * 2);
  const view = new DataView(buffer);
  let offset = 0;
  for (let i = 0; i < float32.length; i++, offset += 2) {
    let s = Math.max(-1, Math.min(1, float32[i]));
    view.setInt16(offset, s < 0 ? s * 0x8000 : s * 0x7fff, true);
  }
  return buffer;
}

/* ================= WS ================= */
function connectWS() {
  const protocol = location.protocol === "https:" ? "wss" : "ws";
  ws = new WebSocket(`${protocol}://${location.host}`);
  ws.binaryType = "arraybuffer";

  ws.onmessage = e => {
    const msg = JSON.parse(e.data);

    if (msg.type === "auth_success") {
      document.getElementById("agentName").textContent = msg.username;
      loginDiv.classList.add("hidden");
      appDiv.classList.remove("hidden");
      log("‚úÖ Authenticated");
    }

    if (msg.type === "auth_failed") {
      alert("Invalid credentials");
    }
  };

  ws.onclose = () => log("‚ùå WebSocket closed");
}

/* ================= LOGIN ================= */
loginBtn.onclick = () => {
  connectWS();
  ws.onopen = () => {
    ws.send(JSON.stringify({
      type: "auth",
      username: username.value.trim(),
      password: password.value
    }));
  };
};

/* ================= START CALL ================= */
startBtn.onclick = async () => {
  if (running) return;

  const useMic = document.getElementById("useMic").checked;
  const useTab = document.getElementById("useTab").checked;
  if (!useMic && !useTab) return alert("Select Mic or Tab");

  ws.send(JSON.stringify({ type: "agent_start" }));
  running = true;

  ctx = new AudioContext({ sampleRate: 16000 });
  await ctx.resume();

  const silent = ctx.createGain();
  silent.gain.value = 0;
  silent.connect(ctx.destination);

  if (useMic) {
    micStream = await navigator.mediaDevices.getUserMedia({ audio: true });
    const src = ctx.createMediaStreamSource(micStream);
    micProcessor = ctx.createScriptProcessor(2048, 1, 1);
    src.connect(micProcessor);
    micProcessor.connect(silent);

    micProcessor.onaudioprocess = e => {
      if (!running) return;
      ws.send(JSON.stringify({ type: "audio_mic" }));
      ws.send(floatTo16BitPCM(e.inputBuffer.getChannelData(0)));
    };

    log("üé§ Mic streaming");
  }

  if (useTab) {
    tabStream = await navigator.mediaDevices.getDisplayMedia({ audio: true, video: true });
    if (tabStream.getAudioTracks().length) {
      const src = ctx.createMediaStreamSource(tabStream);
      tabProcessor = ctx.createScriptProcessor(2048, 1, 1);
      src.connect(tabProcessor);
      tabProcessor.connect(silent);

      tabProcessor.onaudioprocess = e => {
        if (!running) return;
        ws.send(JSON.stringify({ type: "audio_tab" }));
        ws.send(floatTo16BitPCM(e.inputBuffer.getChannelData(0)));
      };

      log("üñ•Ô∏è Tab audio streaming");
    }
  }

  startBtn.disabled = true;
  stopBtn.disabled = false;
  log("‚ñ∂ Call started");
};

/* ================= STOP CALL ================= */
stopBtn.onclick = () => {
  if (!running) return;

  ws.send(JSON.stringify({ type: "agent_stop" }));
  running = false;

  micProcessor?.disconnect();
  tabProcessor?.disconnect();
  ctx?.close();

  micStream?.getTracks().forEach(t => t.stop());
  tabStream?.getTracks().forEach(t => t.stop());

  micProcessor = tabProcessor = null;
  micStream = tabStream = null;
  ctx = null;

  startBtn.disabled = false;
  stopBtn.disabled = true;

  log("‚èπ Call stopped");
};
</script>

</body>
</html>
