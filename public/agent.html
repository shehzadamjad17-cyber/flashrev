<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Agent Audio (Mic + Tab, Stable)</title>

  <style>
    body { font-family: Arial, sans-serif; }
    pre {
      background: #111;
      color: #0f0;
      padding: 10px;
      height: 260px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 13px;
    }
    label { margin-right: 14px; }
  </style>
</head>
<body>

<h2>Agent Audio (Mic + Tab, No Echo)</h2>

<input id="name" placeholder="Agent name" />
<br><br>

<label><input type="checkbox" id="useMic" checked> üé§ Mic</label>
<label><input type="checkbox" id="useTab"> üñ•Ô∏è Tab Audio</label>

<br><br>

<button id="start">Start</button>
<button id="stop" disabled>Stop</button>

<pre id="log"></pre>

<script>
let ws, ctx;
let micStream, tabStream;
let micProcessor, tabProcessor;
let running = false;

const logEl = document.getElementById("log");

function log(msg) {
  logEl.textContent += msg + "\n";
  logEl.scrollTop = logEl.scrollHeight;
}

/* ===== PCM CONVERSION ===== */
function floatTo16BitPCM(float32Array) {
  const buffer = new ArrayBuffer(float32Array.length * 2);
  const view = new DataView(buffer);
  let offset = 0;
  for (let i = 0; i < float32Array.length; i++, offset += 2) {
    let sample = Math.max(-1, Math.min(1, float32Array[i]));
    view.setInt16(offset, sample < 0 ? sample * 0x8000 : sample * 0x7fff, true);
  }
  return buffer;
}

/* ===== SEND AUDIO ===== */
function sendAudio(source, pcmBuffer) {
  if (!ws || ws.readyState !== WebSocket.OPEN) return;

  ws.send(JSON.stringify({
    type: "audio_source",
    source: source
  }));

  ws.send(pcmBuffer);
}

/* ===== START ===== */
document.getElementById("start").onclick = async () => {
  if (running) return;

  const agent = document.getElementById("name").value.trim();
  if (!agent) return alert("Enter agent name");

  const useMic = document.getElementById("useMic").checked;
  const useTab = document.getElementById("useTab").checked;
  if (!useMic && !useTab) return alert("Select at least one audio source");

  log(`Starting agent: ${agent}`);

  ctx = new AudioContext({ sampleRate: 16000 });
  await ctx.resume();

  /* üîá Silent sink (keeps graph alive, no sound) */
  const silentGain = ctx.createGain();
  silentGain.gain.value = 0;
  silentGain.connect(ctx.destination);

  /* ‚úÖ PRODUCTION-SAFE WEBSOCKET */
  const protocol = location.protocol === "https:" ? "wss" : "ws";
  ws = new WebSocket(`${protocol}://${location.host}`);
  ws.binaryType = "arraybuffer";

  ws.onopen = () => {
    ws.send(JSON.stringify({
      type: "agent_join",
      agent: agent
    }));
    log("WebSocket connected");
  };

  ws.onclose = () => log("WebSocket closed");

  /* ===== MIC AUDIO ===== */
  if (useMic) {
    micStream = await navigator.mediaDevices.getUserMedia({
      audio: {
        echoCancellation: true,
        noiseSuppression: true,
        autoGainControl: true,
        channelCount: 1,
        sampleRate: 16000
      }
    });

    const micSource = ctx.createMediaStreamSource(micStream);
    micProcessor = ctx.createScriptProcessor(1024, 1, 1);

    micSource.connect(micProcessor);
    micProcessor.connect(silentGain);

    micProcessor.onaudioprocess = (e) => {
      if (!running) return;
      const pcm = floatTo16BitPCM(e.inputBuffer.getChannelData(0));
      sendAudio("mic", pcm);
    };

    log("üé§ Mic connected (enhanced)");
  }

  /* ===== TAB AUDIO ===== */
  if (useTab) {
    log("Select a TAB and enable 'Share tab audio'");
    tabStream = await navigator.mediaDevices.getDisplayMedia({
      video: true,
      audio: true
    });

    if (tabStream.getAudioTracks().length === 0) {
      log("‚ùå Tab audio NOT shared");
    } else {
      const tabSource = ctx.createMediaStreamSource(tabStream);
      tabProcessor = ctx.createScriptProcessor(1024, 1, 1);

      tabSource.connect(tabProcessor);
      tabProcessor.connect(silentGain);

      tabProcessor.onaudioprocess = (e) => {
        if (!running) return;
        const pcm = floatTo16BitPCM(e.inputBuffer.getChannelData(0));
        sendAudio("tab", pcm);
      };

      log("üñ•Ô∏è Tab audio connected");
    }
  }

  running = true;
  document.getElementById("start").disabled = true;
  document.getElementById("stop").disabled = false;
};

/* ===== STOP ===== */
document.getElementById("stop").onclick = () => {
  if (!running) return;

  log("Stopping agent...");
  running = false;

  micProcessor?.disconnect();
  tabProcessor?.disconnect();
  ctx?.close();

  micStream?.getTracks().forEach(t => t.stop());
  tabStream?.getTracks().forEach(t => t.stop());

  ws?.close();

  ws = ctx = micProcessor = tabProcessor = micStream = tabStream = null;

  document.getElementById("start").disabled = false;
  document.getElementById("stop").disabled = true;

  log("Agent stopped");
};
</script>

</body>
</html>
